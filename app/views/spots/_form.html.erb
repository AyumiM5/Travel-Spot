<div class="container my-5 px-sm-0">
  <div id="spot_error">
    <%= render 'layouts/errors', model: @spot %>
  </div>
  <div class="row my-5">
    <div class="col-md-5 border border-secondary rounded">
      <div class="schedule">
        <div class="mt-3">
          <div class="row ml-2">
            <input id="address" type="textbox" class="col-10" placeholder="Spot名を入力すると検索できます">
            <input type="button" value="検索" onclick="codeAddress()" class='btn btn-sm btn-secondary'>
          </div>
          <div class="my-3 ml-2">
            <%= form_with model:[note, spot] do |f| %>
              <!-- 検索値を隠しデータとして送信-->
              <input type="hidden" name="spot[address]" id="hidden_address">
              <input type="hidden" name="spot[latitude]" id="hidden_latitude">
              <input type="hidden" name="spot[longitude]" id="hidden_longitude">
              <div  class="form-group">
                <%= f.text_area :body, row: '5', class:"form-control input-lg", placeholder: "Spotの説明を記入→保存を押してください" %>
              </div>
              <%= f.submit "保存", class:"btn btn-sm btn-secondary col-3" %>
            <% end %>
          </div>
        </div>
        <div id="spot-index">
          <%= render "spots/index", note: note %>
        </div>
      </div>
    </div>
    <div class="col-md-7">
      <div id="map"></div>
      <script>
        let map
        let geocoder

        function initMap() {
          geocoder = new google.maps.Geocoder()
          map = new google.maps.Map(document.getElementById('map'), {
            center: {
              lat: 35.6585848,
              lng: 139.7432389
            },
            zoom: 12
          });
          
          <% note.spots.each do |m| %>
            (function(){
            var marker = new google.maps.Marker({
                position:{lat: <%= m.latitude %>, lng: <%= m.longitude %>},
                map: map,
            });
  
            })();
          <% end %>
        }

        function codeAddress(){
          let inputAddress = document.getElementById('address').value;

          geocoder.geocode( { 'address': inputAddress}, function(results, status) {
            if (status == 'OK') {
              map.setCenter(results[0].geometry.location);
              var marker = new google.maps.Marker({
                map: map,
                position: results[0].geometry.location
              });

              let hidden_address = document.getElementById('hidden_address');
              hidden_address.setAttribute("value", inputAddress);
              
              let hidden_latitude = document.getElementById('hidden_latitude');
              hidden_latitude.setAttribute("value", marker.position.lat());
              
              let hidden_longitude = document.getElementById('hidden_longitude');
              hidden_longitude.setAttribute("value", marker.position.lng());

            } else {
              alert('該当する結果がありません：' + status);
            }
          });
          
          <% note.spots.each do |spot| %>
          (function(){
          var contentString = "住所：<%= spot.address %>"; 

          var marker = new google.maps.Marker({
              position:{lat: <%= spot.latitude %>, lng: <%= spot.longitude %>},
              map: map,
              title: contentString
          });

          })();
          <% end %>
        }
      </script>
      <script async defer src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=<%= ENV['GOOGLE_API_KEY'] %>&callback=initMap"></script>
    </div>
  </div>
</div>